# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a retro DOS multimedia engine written in Turbo Pascal (1994-era codebase), featuring VGA Mode 13h graphics (320x200 256-color) and HSC (Adlib/OPL2) music playback. The codebase represents vintage demoscene-style programming with direct hardware access, assembly code, and real-mode DOS conventions.

## Folder Structure

```
D:\ENGINE\
├── UNITS\          - Core engine units (VGA, Sound, Input, etc.)
├── TESTS\          - Test programs with compile batch files
├── SETUP\          - Setup program and VOC loader
├── DATA\           - Sample assets (PKM images, HSC music, VOC sounds)
├── DOCS\           - File format documentation
├── VENDOR\         - Third-party libraries (SBDSP, XMS)
└── CONFIG.INI      - Runtime configuration (generated by SETUP.EXE)
```

**Key folders:**
- **UNITS/** - All reusable engine units compile here (TPU files generated)
- **TESTS/** - Test programs demonstrating engine features, includes CxxxTEST.BAT compile scripts
- **SETUP/** - Configuration utility for sound card setup
- **DATA/** - Example assets: TEST.PKM (image), FANTASY.HSC (music), EXPLODE.VOC (sound)
- **DOCS/** - Format specifications (PKM.md, HSC.md)
- **VENDOR/** - Third-party code preserved with original documentation

## Building and Running

### Compilation
This project requires **Turbo Pascal 7.0** (or compatible version) for DOS.

**Automated compilation using batch files (recommended):**
```bash
# Compile test programs with all dependencies
cd TESTS
CVGATEST.BAT    - VGA graphics test
CSNDTEST.BAT    - Sound bank test
CIMGTEST.BAT    - Full demo with sprites, music, sound FX

# Compile setup program
cd SETUP
CSETUP.BAT      - Configuration utility
```

**Manual compilation:**
```bash
# Compile units first (from UNITS folder)
cd UNITS
tpc VGA.PAS
tpc PKMLOAD.PAS
tpc SBDSP.PAS
# ... etc

# Then compile test program with unit path
cd ..\TESTS
tpc -U..\UNITS VGATEST.PAS
```

**Batch file notes:**
- Compile batch files are prefixed with `C` (e.g., CVGATEST.BAT) to avoid name conflicts with EXE files
- All dependencies are compiled automatically in correct order
- Units are compiled to UNITS\ folder, test programs to TESTS\ folder
- Use `-U..\UNITS` flag to reference compiled unit (.TPU) files

### Running
Execute on DOS (or DOSBox-X/FreeDOS):
```bash
# Run test programs
cd TESTS
VGATEST.EXE    - Load and display PKM image
SNDTEST.EXE    - XMS sound bank interactive test
IMGTEST.EXE    - Sprite animation with music and sound

# Run setup utility
cd SETUP
SETUP.EXE      - Configure sound card settings
```

**IMGTEST usage:**
- ESC: Exit
- E: Play explosion sound effect
- Optional flags: `IMGTEST novsync` (disable VSync), `IMGTEST nomusic` (disable music)

## Code Architecture

### Core Units

**SBDSP.PAS** - Professional Sound Blaster DSP driver (1995, by Romesh Prakashpalan)
- Professional-grade Sound Blaster driver from VENDOR/SBDSP2B
- Double-buffered DMA playback for smooth audio
- Interrupt-driven (IRQ5/7) with proper DSP acknowledgment and PIC EOI handling
- Supports 8-bit mono/stereo playback via DMA channels 0-3
- `ResetDSP(Base, IRQ, DMA, HighDMA)`: Initialize Sound Blaster (Base: 2=$220, IRQ: 5/7, DMA: 1)
- `PlaySound(BaseSoundType)`: Play raw 8-bit PCM from memory (up to 64KB)
- `PlaySoundRPD(filename)`: Play RPD format files from disk with streaming
- `DMAStop` / `DMAContinue`: Pause/resume playback
- `SpeakerOn` / `SpeakerOff`: Control speaker output
- `InstallHandler` / `UninstallHandler`: Manage IRQ interrupt hooks
- Global `Playing` boolean flag indicates playback status
- **CRITICAL**: Always call `UninstallHandler` before exit to unhook interrupt
- **NOTE**: Compatible with HSC music playback (uses different interrupts)

**VOCLOAD.PAS** - VOC file loader helper for SBDSP
- Loads Creative Voice File (.VOC) format and plays via SBDSP
- `PlayVOCFile(filename)`: Load and play VOC file, returns success boolean
- `FreeVOCBuffer`: Free allocated sound buffer (call after playback or on exit)
- Automatically frees previous buffer when loading new sound
- Extracts sample rate and converts to SBDSP's `BaseSoundType` format
- **MEMORY**: Buffer stays allocated during playback to prevent DMA read errors
- **USAGE**: Don't wait for `Playing` flag in tight loop if HSC music is active (causes freezes)

**XMS.PAS** - Extended Memory Specification (XMS) interface (1992, by KIV without Co) ✅ **WORKING**
- Professional XMS driver providing access to extended memory (above 1MB) via HIMEM.SYS
- `XMSinstalled`: Check if XMS driver is loaded
- `AllocXMS(KB)`: Allocate blocks in extended memory (in kilobytes)
- `FreeXMS(Handle)`: Free allocated XMS blocks
- `Mem2Xms` / `Xms2Mem`: Transfer data to/from extended memory (handles odd-byte transfers automatically)
- `MoveXMS(EMMstruct)`: Low-level XMS memory move operation
- `GetXMSmem`: Query available XMS memory
- **CRITICAL**: When handle=0 in EMMstruct, offset must be pointer value (seg:ofs), NOT physical linear address
- **USE CASE**: Store large data (sprites, maps, samples) in XMS, swap on demand to conventional memory

**SNDBANK.PAS** - XMS-based sound library manager for SBDSP (2025, DMA-safe buffer by ChatGPT)
- Stores multiple VOC files in extended memory, loads on demand for playback
- `TSoundBank` object type for managing sound effects library
- `Init`: Initialize sound bank and verify XMS availability
- `LoadSound(filename)`: Load VOC file into XMS memory, returns sound ID (-1 on error)
- `PlaySound(ID)`: Transfer sound from XMS to conventional memory and play via SBDSP
- `StopSound`: Stop currently playing sound
- `Done`: Cleanup - free all XMS blocks and buffers
- **DMA-SAFE ALLOCATION**: Allocates playback buffers that don't cross 64KB page boundaries (critical for DMA)
- **MEMORY**: Sounds stored in XMS, only playback buffer in conventional memory (saves precious DOS RAM)
- **USAGE**: Ideal for games with multiple sound effects - load all at startup, play repeatedly without disk I/O
- **IMPORTANT**: Requires XMS driver (HIMEM.SYS) and Sound Blaster initialization via SBDSP.ResetDSP

**VGA.PAS** - Low-level VGA Mode 13h graphics driver
- `TFrameBuffer`: 64000-byte (320x200) pixel buffer type
- `TPalette`: 256-color RGB palette (0-63 range for VGA DAC)
- `InitVGA`/`CloseVGA`: Switch between text mode and Mode 13h
- `CreateFrameBuffer`/`FreeFrameBuffer`: Memory-managed pixel buffer
- `RenderFrameBuffer`: Assembly routine to blit buffer to VGA memory ($A000:0000)
- `SetPalette`: Upload 256-color palette to VGA DAC
- `LoadPalette`: Load 768-byte .PAL file
- `WaitForVSync`: Sync to vertical blanking interval (prevents tearing)
- All rendering uses double-buffering pattern for flicker-free updates

**VGAPRINT.PAS** - Bitmap font text renderer for Mode 13h (2025)
- Renders text overlays on framebuffers using embedded 8x8 bitmap font
- `PrintText(x, y, text, color, framebuffer)`: Draw text string at specified position
- Supports printable ASCII characters (32-127)
- Font data embedded directly in unit (no external files needed)
- Automatic clipping at screen boundaries (320x200)
- Non-printable characters replaced with spaces
- **USE CASE**: FPS counters, debug text, HUD overlays, game UI text (see IMGTEST.PAS)

**PLAYHSC.PAS** - HSC music player wrapper (1994, by GLAMOROUS RAY)
- `HSC_obj` object type for music playback
- Links to external `HSCOBJ.OBJ` (assembly player core)
- `Init(AdlibAddress)`: Auto-detects Adlib at port 388h (pass 0 for auto)
- `LoadFile(filename)` / `LoadMem(ptr)`: Load from disk or embedded data
- `Start` / `Stop` / `Fade`: Playback control
- Hooks into timer interrupt (IRQ0) for automatic polling
- **CRITICAL**: Always call `Done` destructor before exit to unhook interrupt
- **IRQ0 WARNING**: Do NOT read PIT Timer 0 counters or hook IRQ0 while HSC is active - causes interrupt conflicts and sound issues. Use RTCTimer.PAS (IRQ8) for high-resolution timing instead.

**RTCTIMER.PAS** - Real-Time Clock interrupt timer (2025, RTC IRQ8 high-resolution timing)
- Provides high-resolution timing via RTC periodic interrupt (IRQ8 on slave PIC)
- `InitRTC(Freq)`: Initialize RTC at specified frequency (2-8192 Hz, typical: 1024 Hz)
- `DoneRTC`: Cleanup - disable periodic interrupt and restore handler
- `GetTimeSeconds`: Returns elapsed time in seconds as Real
- `RTC_Ticks`: Global tick counter (increments at configured frequency)
- **IRQ8 ADVANTAGE**: Completely separate from PIT Timer 0 (IRQ0) - no conflicts with HSC music player or BIOS timer
- **CRITICAL**: Always call `DoneRTC` before exit to unhook interrupt
- **PIC MASKING**: Only masks IRQ8 when cleaning up - NEVER masks IRQ2 cascade (would disable entire slave PIC)
- **USE CASE**: Frame-rate independent game loops, delta timing, animation (see IMGTEST.PAS for example)

**PKMLOAD.PAS** - PKM image format loader
- PKM format: RLE-compressed paletted image format from GrafX2 drawing program (http://grafx2.chez.com/)
- `LoadPKM(filename, buffer, palette)`: Decompresses image to framebuffer
- **Current limitation**: Only loads 320x200 pixel images (under construction - will support arbitrary sizes later)
- Header structure:
  - Signature: "PKM" (3 bytes)
  - Version, pack markers (Pack_byte/Pack_word for RLE)
  - Width/Height (currently must be 320x200)
  - 768-byte palette (256 RGB triplets)
  - RLE-compressed pixel data (byte-run or word-run encoding)

**KEYBOARD.PAS** - Low-level keyboard handler using scan codes
- Hooks INT 9h (keyboard interrupt) for direct hardware access (no BIOS delays)
- `InitKeyboard`: Initialize keyboard handler - **MUST call before use**
- `DoneKeyboard`: Restore original interrupt handler - **MUST call before exit**
- `IsKeyDown(scancode)`: Returns true while key is physically held down (continuous input)
- `IsKeyPressed(scancode)`: Returns true once when key is **released** (edge detection)
- `ClearKeyPressed`: Clears all checked key press flags - call once at end of game loop
- **Scan code constants**: `Key_A` through `Key_Z`, `Key_0` through `Key_9`, `Key_F1` through `Key_F12`, arrow keys (`Key_Up`, `Key_Down`, `Key_Left`, `Key_Right`), modifiers (`Key_LShift`, `Key_RShift`, `Key_LCtrl`, `Key_LAlt`), special keys (`Key_Escape`, `Key_Enter`, `Key_Space`, `Key_Backspace`, `Key_Tab`)
- **Key detection behavior**:
  - `IsKeyPressed` triggers on key **release** (not press) to ensure no quick taps are missed
  - Uses `KeyChecked` array to track which keys were queried this frame
  - Only checked keys get cleared by `ClearKeyPressed`, preserving unchecked events
  - Can call `IsKeyPressed` multiple times per frame for same key safely
- **CRITICAL**: Always call `DoneKeyboard` before exit to unhook interrupt handler, or system will hang

**CONFIG.PAS** - Configuration management
- Handles loading and saving settings to CONFIG.INI text file (INI format)
- `TConfig` record type containing sound type and Sound Blaster settings
- `LoadConfig(var Config)`: Load configuration from INI file, sets defaults if missing (SoundCard defaults to 0, SBPort defaults to $22)
- `SaveConfig(const Config)`: Save configuration to INI file
- **Constants**:
  - `GameTitle`, `GameVersion`: Application metadata constants
  - `SoundCard_None` (0), `SoundCard_Adlib` (1), `SoundCard_SoundBlaster` (2) for sound card enumeration
  - `ConfigFile`: Filename constant ('CONFIG.INI')
- **INI Format**: Standard INI-style text file with `[Sound]` section and key=value pairs
- **Port Value Format**: SBPort stored as base value (e.g., $22 for port $220); SETUP.PAS handles conversion for display
- Used by SETUP.PAS and can be used by games to detect sound hardware configuration

**TEXTUI.PAS** - Text mode UI library
- Direct video memory access ($B800:0000) for fast text rendering
- **Types**: `TMenu`, `TMenuItem` (menu system with linked list structure)
- **Cursor management**: `HideCursor`, `ShowCursor`
- **Text rendering**: `PutCharAt`, `RenderText`, `RenderCenterText`, `RenderEmptyLine`
- **Box rendering**: `RenderBox` (with drop shadows), `RenderBackground`
- **Menu system**:
  - `AddMenuItem`: Add item to menu with procedure pointer callback
  - `AddEmptyMenuItem`: Add disabled separator item
  - `RenderMenu`: Draw menu with highlighted selection
  - `RunMenu`: Handle keyboard navigation and execute selected item
  - `FreeMenu`: Clean up menu items
  - `ShowMessage`: Shows a message with an info line, waits for a key press, returns with the pressed scancode
- **Menu features**: Disabled items (drawn in gray, skipped during navigation), inverted color selection bar
- First menu item is always enabled (cannot be disabled)

### File Formats

**PKM Images**:
- Format from GrafX2 drawing program (http://grafx2.chez.com/)
- TEST.PKM (example image)
- Indexed color (256 colors) with embedded palette
- RLE compression using configurable pack markers
- **Current**: Only 320x200 images supported ⚠️ **UNDER CONSTRUCTION** (arbitrary dimensions planned)

**HSC Music**:
- FANTASY.HSC (example)
- Adlib OPL2 tracker format
- Embeddable via BINOBJ.EXE → .OBJ linking

### Memory Model
- Uses Pascal heap (`GetMem`/`FreeMem`) for dynamic allocations
- 64KB framebuffer allocation per image
- Music files loaded entirely into memory
- Real-mode DOS constraints (640KB conventional memory)

### Assembly Integration
- Inline `assembler` blocks for performance-critical code
- External .OBJ linking for HSCOBJ.OBJ (HSC player core)
- Direct hardware access (VGA BIOS INT 10h, VGA memory writes)
- BINOBJ.EXE used to embed binary data as linkable objects

## Development Workflow

### Testing Graphics
```pascal
// Modify VGATEST.PAS to experiment
InitVGA;
FrameBuffer := CreateFrameBuffer;
// Draw to FrameBuffer^ array...
RenderFrameBuffer(FrameBuffer);
ReadLn; // Wait for user
CloseVGA;
FreeFrameBuffer(FrameBuffer);
```

### Testing Music
```pascal
Music.Init(0);
if Music.LoadFile('YOURFILE.HSC') then
begin
  Music.Start;
  // Do stuff while music plays...
  Music.Done; // MUST call before exit
end;
```

### Testing Sound Effects

**Simple approach (VocLoad)** - For single sounds or testing:
```pascal
uses SBDSP, VocLoad;

begin
  { Initialize Sound Blaster: Base 2 ($220), IRQ 5, DMA 1, no High DMA }
  if ResetDSP(2, 5, 1, 0) then
  begin
    { Play VOC file }
    if PlayVOCFile('DATA\EXPLOSION.VOC') then
    begin
      { Sound plays in background via DMA }
      { Optionally wait for completion if no music is playing }
      while Playing do
        asm nop end;  { Allow interrupts }
    end;

    { Cleanup on exit }
    UninstallHandler;
    FreeVOCBuffer;
  end;
end;
```

**Advanced approach (SndBank)** - For games with multiple sounds:
```pascal
uses SBDSP, SndBank, XMS;

var
  Bank: TSoundBank;
  ExplosionID, LaserID: Integer;

begin
  { Initialize Sound Blaster }
  if not ResetDSP(2, 5, 1, 0) then Halt(1);

  { Initialize sound bank (requires XMS/HIMEM.SYS) }
  if not Bank.Init then Halt(1);

  { Load sounds into XMS at startup }
  ExplosionID := Bank.LoadSound('DATA\EXPLODE.VOC');
  LaserID := Bank.LoadSound('DATA\LASER.VOC');

  { Play sounds on demand - no disk I/O, just XMS transfer }
  Bank.PlaySound(ExplosionID);  { Fast! Data already in XMS }

  { Game loop... }

  { Cleanup on exit }
  Bank.Done;  { Frees all XMS blocks and buffers }
  UninstallHandler;
end;
```

### Testing Keyboard
```pascal
uses Keyboard;

begin
  InitKeyboard;

  while GameRunning do
  begin
    { Continuous input - movement }
    if IsKeyDown(Key_W) then
      Player.Y := Player.Y - 1;

    { Single-press input - actions }
    if IsKeyPressed(Key_Space) then
      FireWeapon;

    if IsKeyPressed(Key_Escape) then
      GameRunning := False;

    { Game logic and rendering... }

    { MUST call at end of loop }
    ClearKeyPressed;
  end;

  DoneKeyboard;  { MUST call before exit }
end;
```

### Running Setup Program
```bash
# Compile SETUP.PAS
tpc SETUP.PAS

# Run the setup program
SETUP.EXE
```

**SETUP.PAS** provides a DOS-style configuration utility:
- Uses **CONFIG.PAS** and **TEXTUI.PAS** units
- **Architecture**:
  - Menu-driven interface using TMenu/TMenuItem linked lists
  - Far procedure pointers (`{$F+}`) for menu callbacks
  - Direct video memory rendering via TEXTUI
  - Main menu with submenu navigation
- **Features**:
  - Sound card selection: None, Adlib, Sound Blaster
  - Saves settings to CONFIG.INI text file
  - Menu system with disabled items support
- **Controls**:
  - Up/Down arrow keys for navigation
  - ENTER to select menu item
  - ESC to cancel/exit
- **Usage Pattern**:
  ```pascal
  uses Config;

  var
    GameConfig: TConfig;

  begin
    { Load config at game startup }
    LoadConfig(GameConfig);

    { Initialize sound based on config }
    case GameConfig.SoundCard of
      SoundCard_Adlib: InitAdlib;
      SoundCard_SoundBlaster:
        begin
          SoundCard.Port := GameConfig.SBPort;
          SoundCard.IRQ := GameConfig.SBIRQ;
          SoundCard.DMA := GameConfig.SBDMA;
          SoundCard.Init;
        end;
    end;
  end;
  ```

**Example CONFIG.INI file**:
```ini
; DOS Game Engine Configuration

[Sound]
SoundCard=2
SBPort=34
SBIRQ=5
SBDMA=1
```
Notes:
- SoundCard defaults to 0 (None) if CONFIG.INI doesn't exist
- SBPort is stored as base value: 34 ($22) represents port $220, 36 ($24) represents port $240, etc.
- SETUP.PAS displays/accepts the actual port value ($220) and converts to/from base value automatically

### Embedding Music in EXE
```bash
# Convert HSC to linkable OBJ
BINOBJ.EXE MUSIC.HSC MUSIC.OBJ MUSIC_DATA

# In your Pascal code:
{$F+}
{$L MUSIC.OBJ}
PROCEDURE MUSIC_DATA; EXTERNAL;
{$F-}

# Then use:
Music.LoadMem(@MUSIC_DATA);
```

## Creating VOC Files (Windows 11)

### Method 1: Audacity (Recommended)
1. Download from https://www.audacityteam.org/
2. Import audio (WAV, MP3, etc.)
3. **Tracks → Mix → Mix Stereo Down to Mono**
4. **Tracks → Resample → 11025 Hz** (or 22050 Hz)
5. **File → Export → Export Audio**
   - Format: "Other uncompressed files"
   - Header: "VOC (Creative Labs)"
   - Encoding: "Unsigned 8-bit PCM"

### Method 2: FFmpeg
```bash
ffmpeg -i input.wav -ar 11025 -ac 1 -acodec pcm_u8 output.voc
```

## Test Programs

- **VGATEST.PAS**: VGA graphics test with a PKM image load and show
- **KBTEST.PAS**: Keyboard handler test (demonstrates IsKeyDown vs IsKeyPressed)
- **XMSTEST2.PAS**: XMS round-trip test (write pattern to XMS, read back, verify) ✅
- **SNDTEST.PAS**: XMS sound bank test with SBDSP (loads VOC into XMS, plays on demand) ✅
- **IMGTEST.PAS**: Advanced sprite animation demo with RTCTimer (delta timing, FPS counter, HSC music + sound effects) ✅
- **SETUP.PAS**: Menu-driven setup program using TEXTUI for sound card configuration (includes music and sound testing)

## Common Pitfalls

1. **Music interrupts**: Failing to call `HSC_obj.Done` will leave timer interrupt hooked, causing system hang on program exit
2. **Keyboard interrupts**: Failing to call `DoneKeyboard` will leave INT 9h hooked, causing system hang on program exit
3. **RTC timer interrupts**: Failing to call `DoneRTC` will leave IRQ8 hooked, causing DOSBox-X crash when trying to run other programs after exit
4. **IRQ2 cascade masking**: NEVER mask IRQ2 (bit 2 of master PIC) - it's the cascade from slave PIC to master. Masking IRQ2 disables ALL slave PIC interrupts (IRQ8-15) including PS/2 mouse (IRQ12), causing erratic mouse behavior in DOSBox-X and keyboard issues in 86Box. Only mask the specific IRQ you're cleaning up (e.g., IRQ8 for RTC timer)
5. **Ctrl+C/Ctrl+Break cleanup**: Install an ExitProc handler to ensure interrupts are unhooked even on abnormal program termination, or interrupt vectors will point to freed memory
6. **Sound Blaster cleanup**: Always call `UninstallHandler` and `FreeVOCBuffer` before exit to unhook IRQ and free DMA buffer
7. **Sound buffer management**: Don't free VOC buffers while `Playing` is True - causes DMA to read freed memory (crackling/shortened sound)
8. **Music + Sound conflicts**: When HSC music plays, don't wait in tight `while Playing` loop - causes freeze. Let sound play in background.
9. **VGA mode cleanup**: Always call `CloseVGA` before exit or terminal will stay in graphics mode
10. **Memory leaks**: Match every `CreateFrameBuffer` with `FreeFrameBuffer`
11. **Keyboard loop order**: Always call `ClearKeyPressed` at the **end** of the game loop
12. **DMA boundaries**: Sound samples must not cross 64KB page boundaries (handled automatically by SBDSP)
13. **Image dimensions**: PKM loader enforces 320x200; other sizes will fail silently
14. **Palette**: PKM palette values are used directly (0-63 for VGA DAC)
15. **File paths**: DOS 8.3 filenames, case-insensitive, backslash paths
16. **XMS far calls**: Turbo Pascal 7.0 has quirks with far procedure pointers - XMS.PAS needs fixing
17. **Timer interrupt safety**: Keep interrupt handlers minimal - complex logic can cause crashes. Always chain to original BIOS handler.
18. **Menu callbacks**: Procedures used as menu item callbacks must be compiled with `{$F+}` (far calls) directive, otherwise they cannot be assigned to procedure pointers
19. ~~**DOSBox-X sound cutoff mystery**~~: **✅ SOLVED** - The infamous sound cutoff bug was caused by **PIT Timer 0 / IRQ0 interrupt conflicts**. When HSC music player hooks IRQ0 for polling, reading PIT Timer 0 counters creates race conditions and nested interrupt issues that disrupt Sound Blaster DMA timing. **Solution**: Use **RTCTimer.PAS** (RTC IRQ8 on slave PIC) for high-resolution timing instead of reading PIT Timer 0. IRQ8 is completely separate from IRQ0, eliminating all conflicts. The "dummy variable workaround" was masking a timing-dependent bug by changing stack layout - switching to RTC fixed the root cause. See IMGTEST.PAS for the corrected implementation.
20. **PIT Timer 0 / IRQ0 conflicts**: Never share PIT Timer 0 with interrupt-driven systems like HSC music player. Reading PIT counters or hooking IRQ0 while HSC is active causes interrupt conflicts, timing glitches, stack corruption, and sound cutoff. **Always use RTCTimer.PAS (IRQ8) for high-resolution timing** - it's on the slave PIC and completely isolated from music/BIOS timers.

## Technical Constraints

- **Platform**: DOS real mode (16-bit x86)
- **Compiler**: Turbo Pascal 7.0 (use TPC.EXE or TURBO.EXE IDE)
- **Testing environment**: DOSBox-X recommended
- **Graphics**: VGA Mode 13h only (320x200, 256 colors)
- **Audio**:
  - Adlib/OPL2 for music (HSC tracker format)
  - Sound Blaster for 8-bit digital audio (VOC files)
  - DMA channels 0-3 supported (default: channel 1)
- **Memory**:
  - Conventional: 640KB real-mode limit
  - Extended: XMS support via XMS.PAS (HIMEM.SYS required) - ✅ WORKING
- **Max file size**: 64KB code segments, heap limited by DOS memory
- **No multithreading**: Single-threaded with interrupt-based music/DMA audio

## Vendor Libraries

The `VENDOR/` directory contains third-party libraries and tools:

**VENDOR/SBDSP2B/** - SBDSP Sound Blaster driver v2.0β (1995)
- Professional Sound Blaster DSP unit by Romesh Prakashpalan
- Includes: SBDSP.PAS, SBDSP.TPU, test programs, and conversion utilities
- **VOC2RPD.EXE**: Converts Creative Voice Files to RPD format
- **WAV2RPD.EXE**: Converts WAV files to RPD format
- **TESTDSP.PAS**: Example program showing SBDSP usage
- **SBDSP.TXT**: Full documentation and usage guide
- Copied SBDSP.PAS to root for use in engine
- Original source preserved for reference and licensing

## Known Issues

1. ~~**XMS.PAS far call problem**~~: **RESOLVED** - XMS.PAS now working correctly. The professional XMS driver by KIV without Co (1992) uses self-modifying code to patch the far call address at runtime.